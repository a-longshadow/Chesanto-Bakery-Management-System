{% extends 'accounts/base.html' %}

{% block title %}Close Books - {{ date|date:"M d, Y" }}{% endblock %}

{% block content %}
<style>
    /* Book Closing Layout */
    .closing-container {
        max-width: 900px;
        margin: 0 auto;
        padding: var(--spacing-6) var(--spacing-4);
    }

    .closing-header {
        text-align: center;
        margin-bottom: var(--spacing-8);
    }

    .closing-icon {
        font-size: 4rem;
        margin-bottom: var(--spacing-4);
    }

    .closing-title {
        font-size: 2rem;
        font-weight: 600;
        color: var(--color-gray-900);
        margin: 0 0 var(--spacing-2) 0;
    }

    .closing-subtitle {
        font-size: 1rem;
        color: var(--color-gray-600);
    }

    /* Summary Card */
    .summary-card {
        background: white;
        border-radius: 12px;
        padding: var(--spacing-6);
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        margin-bottom: var(--spacing-6);
    }

    .summary-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--color-gray-900);
        margin: 0 0 var(--spacing-5) 0;
        display: flex;
        align-items: center;
        gap: var(--spacing-2);
    }

    /* Summary Grid */
    .summary-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: var(--spacing-5);
    }

    .summary-item {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-1);
    }

    .summary-item__label {
        font-size: 0.875rem;
        color: var(--color-gray-600);
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .summary-item__value {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--color-gray-900);
    }

    .summary-item__value--primary {
        color: var(--color-primary);
    }

    /* Checklist */
    .checklist-card {
        background: white;
        border-radius: 12px;
        padding: var(--spacing-6);
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        margin-bottom: var(--spacing-6);
    }

    .checklist-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--color-gray-900);
        margin: 0 0 var(--spacing-5) 0;
        display: flex;
        align-items: center;
        gap: var(--spacing-2);
    }

    .checklist {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-3);
    }

    .checklist-item {
        display: flex;
        align-items: flex-start;
        gap: var(--spacing-3);
        padding: var(--spacing-3);
        background-color: var(--color-gray-50);
        border-radius: 8px;
    }

    .checklist-item--complete {
        background-color: var(--color-success-light);
    }

    .checklist-item--incomplete {
        background-color: var(--color-warning-light);
    }

    .checklist-icon {
        font-size: 1.25rem;
        flex-shrink: 0;
    }

    .checklist-content {
        flex: 1;
    }

    .checklist-label {
        font-size: 0.875rem;
        font-weight: 600;
        color: var(--color-gray-900);
        margin: 0 0 var(--spacing-1) 0;
    }

    .checklist-description {
        font-size: 0.75rem;
        color: var(--color-gray-700);
        margin: 0;
    }

    /* Variance Alert */
    .variance-alert {
        background-color: var(--color-warning-light);
        border-left: 4px solid var(--color-warning);
        padding: var(--spacing-4);
        border-radius: 8px;
        margin-bottom: var(--spacing-6);
        display: flex;
        align-items: center;
        gap: var(--spacing-3);
    }

    .variance-alert__icon {
        font-size: 1.5rem;
        color: var(--color-warning);
    }

    .variance-alert__content {
        flex: 1;
    }

    .variance-alert__title {
        font-size: 0.875rem;
        font-weight: 600;
        color: var(--color-gray-900);
        margin: 0 0 var(--spacing-1) 0;
    }

    .variance-alert__text {
        font-size: 0.875rem;
        color: var(--color-gray-700);
        margin: 0;
    }

    /* Confirmation Card */
    .confirmation-card {
        background: white;
        border-radius: 12px;
        padding: var(--spacing-6);
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        border: 2px solid var(--color-error);
    }

    .confirmation-title {
        font-size: 1.125rem;
        font-weight: 600;
        color: var(--color-gray-900);
        margin: 0 0 var(--spacing-3) 0;
        display: flex;
        align-items: center;
        gap: var(--spacing-2);
    }

    .confirmation-text {
        font-size: 0.875rem;
        color: var(--color-gray-700);
        margin: 0 0 var(--spacing-5) 0;
        line-height: 1.6;
    }

    .confirmation-warning {
        background-color: var(--color-error-light);
        padding: var(--spacing-3);
        border-radius: 6px;
        margin-bottom: var(--spacing-5);
    }

    .confirmation-warning__text {
        font-size: 0.875rem;
        color: var(--color-error);
        font-weight: 600;
        margin: 0;
    }

    /* Action Buttons */
    .form-actions {
        display: flex;
        gap: var(--spacing-3);
        justify-content: flex-end;
    }

    .btn {
        display: inline-flex;
        align-items: center;
        gap: var(--spacing-2);
        padding: var(--spacing-3) var(--spacing-5);
        border-radius: 8px;
        font-size: 0.875rem;
        font-weight: 500;
        text-decoration: none;
        transition: all 0.2s;
        border: none;
        cursor: pointer;
    }

    .btn--primary {
        background-color: var(--color-error);
        color: white;
    }

    .btn--primary:hover {
        background-color: var(--color-error-dark);
    }

    .btn--secondary {
        background-color: white;
        color: var(--color-gray-700);
        border: 1px solid var(--color-gray-300);
    }

    .btn--secondary:hover {
        background-color: var(--color-gray-50);
    }

    /* Success State */
    .success-card {
        background: linear-gradient(135deg, var(--color-success-light) 0%, var(--color-primary-light) 100%);
        border-radius: 12px;
        padding: var(--spacing-8);
        text-align: center;
    }

    .success-icon {
        font-size: 4rem;
        margin-bottom: var(--spacing-4);
    }

    .success-title {
        font-size: 1.5rem;
        font-weight: 600;
        color: var(--color-gray-900);
        margin: 0 0 var(--spacing-2) 0;
    }

    .success-text {
        font-size: 1rem;
        color: var(--color-gray-700);
        margin: 0 0 var(--spacing-5) 0;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
        .summary-grid {
            grid-template-columns: 1fr;
        }

        .form-actions {
            flex-direction: column-reverse;
        }

        .btn {
            width: 100%;
            justify-content: center;
        }
    }
</style>

<div class="closing-container">
    {% if daily_production.is_closed %}
    <!-- Already Closed State -->
    <div class="success-card">
        <div class="success-icon">‚úÖ</div>
        <h1 class="success-title">Books Already Closed</h1>
        <p class="success-text">This production day was closed at {{ daily_production.closed_at|date:"g:i A on F d, Y" }}</p>
        <a href="{% url 'production:daily_production_date' date=date %}" class="btn btn--secondary">
            ‚Üê Back to Production
        </a>
    </div>
    {% else %}
    <!-- Closing Header -->
    <div class="closing-header">
        <div class="closing-icon">üîí</div>
        <h1 class="closing-title">Close Daily Books</h1>
        <p class="closing-subtitle">{{ date|date:"l, F d, Y" }}</p>
    </div>

    <!-- Production Summary -->
    <div class="summary-card">
        <h2 class="summary-title">
            <span>üìä</span>
            Production Summary
        </h2>
        <div class="summary-grid">
            <div class="summary-item">
                <span class="summary-item__label">Total Batches</span>
                <span class="summary-item__value">{{ batches|length }}</span>
            </div>
            <div class="summary-item">
                <span class="summary-item__label">Bread Produced</span>
                <span class="summary-item__value">{{ daily_production.bread_produced|default:"0" }}</span>
            </div>
            <div class="summary-item">
                <span class="summary-item__label">KDF Produced</span>
                <span class="summary-item__value">{{ daily_production.kdf_produced|default:"0" }}</span>
            </div>
            <div class="summary-item">
                <span class="summary-item__label">Scones Produced</span>
                <span class="summary-item__value">{{ daily_production.scones_produced|default:"0" }}</span>
            </div>
            <div class="summary-item">
                <span class="summary-item__label">Indirect Costs</span>
                <span class="summary-item__value summary-item__value--primary">KES {{ daily_production.total_indirect_costs|default:"0"|floatformat:2 }}</span>
            </div>
        </div>
    </div>

    <!-- Variance Alert (if applicable) -->
    {% if daily_production.has_variance %}
    <div class="variance-alert">
        <span class="variance-alert__icon">‚ö†Ô∏è</span>
        <div class="variance-alert__content">
            <h3 class="variance-alert__title">Reconciliation Variance Detected</h3>
            <p class="variance-alert__text">
                Stock reconciliation shows a variance of {{ daily_production.variance_percentage|floatformat:1 }}% 
                (threshold: 5%). Please review reconciliation notes before closing.
            </p>
        </div>
    </div>
    {% endif %}

    <!-- Pre-closing Checklist -->
    <div class="checklist-card">
        <h2 class="checklist-title">
            <span>‚úîÔ∏è</span>
            Pre-Closing Checklist
        </h2>
        <div class="checklist">
            <div class="checklist-item {% if batches %}checklist-item--complete{% else %}checklist-item--incomplete{% endif %}">
                <span class="checklist-icon">{% if batches %}‚úÖ{% else %}‚ö†Ô∏è{% endif %}</span>
                <div class="checklist-content">
                    <p class="checklist-label">Production batches recorded</p>
                    <p class="checklist-description">{{ batches|length }} batch{% if batches|length != 1 %}es{% endif %} recorded for today</p>
                </div>
            </div>

            <div class="checklist-item {% if daily_production.total_indirect_costs > 0 %}checklist-item--complete{% else %}checklist-item--incomplete{% endif %}">
                <span class="checklist-icon">{% if daily_production.total_indirect_costs > 0 %}‚úÖ{% else %}‚ö†Ô∏è{% endif %}</span>
                <div class="checklist-content">
                    <p class="checklist-label">Indirect costs entered</p>
                    <p class="checklist-description">Total: KES {{ daily_production.total_indirect_costs|default:"0"|floatformat:2 }}</p>
                </div>
            </div>

            <div class="checklist-item {% if daily_production.closing_bread_stock >= 0 %}checklist-item--complete{% else %}checklist-item--incomplete{% endif %}">
                <span class="checklist-icon">{% if daily_production.closing_bread_stock >= 0 %}‚úÖ{% else %}‚ö†Ô∏è{% endif %}</span>
                <div class="checklist-content">
                    <p class="checklist-label">Stock reconciliation calculated</p>
                    <p class="checklist-description">Opening + Produced - Dispatched + Returned = Closing</p>
                </div>
            </div>

            <div class="checklist-item {% if not daily_production.has_variance %}checklist-item--complete{% else %}checklist-item--incomplete{% endif %}">
                <span class="checklist-icon">{% if not daily_production.has_variance %}‚úÖ{% else %}‚ö†Ô∏è{% endif %}</span>
                <div class="checklist-content">
                    <p class="checklist-label">Variance check</p>
                    <p class="checklist-description">{% if daily_production.has_variance %}Variance: {{ daily_production.variance_percentage|floatformat:1 }}%{% else %}No significant variance detected{% endif %}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirmation Card -->
    <div class="confirmation-card">
        <form method="post">
            {% csrf_token %}
            <h3 class="confirmation-title">
                <span>üö®</span>
                Confirm Book Closing
            </h3>
            <p class="confirmation-text">
                Closing the daily books will finalize all production batches and lock editing for today's date.
                This action calculates closing stock for all products and sets opening stock for the next day.
            </p>

            <div class="confirmation-warning">
                <p class="confirmation-warning__text">
                    ‚ö†Ô∏è This action cannot be undone. Only CEO/Manager/Admin can edit closed books.
                </p>
            </div>

            <div class="form-actions">
                <a href="{% url 'production:daily_production_date' date=date %}" class="btn btn--secondary">
                    Cancel
                </a>
                <button type="submit" class="btn btn--primary">
                    üîí Close Books
                </button>
            </div>
        </form>
    </div>
    {% endif %}
</div>

{% endblock %}
