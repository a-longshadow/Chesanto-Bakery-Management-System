<style>
    .deficits-table table {
        width: 100%;
        border-collapse: collapse;
    }
    
    .deficits-table th {
        background: var(--color-gray-50);
        padding: var(--space-3);
        text-align: left;
        font-size: var(--text-sm);
        font-weight: 600;
        color: var(--color-gray-700);
        border-bottom: 2px solid var(--color-gray-200);
    }
    
    .deficits-table td {
        padding: var(--space-3);
        border-bottom: 1px solid var(--color-gray-100);
        font-size: var(--text-sm);
    }
    
    .deficits-table tr.deficit-critical {
        background: var(--color-red-50);
    }
    
    .deficits-table tr.deficit-critical:hover {
        background: var(--color-red-100);
    }
    
    .deficits-table tr.deficit-moderate {
        background: var(--color-orange-50);
    }
    
    .deficits-table tr.deficit-moderate:hover {
        background: var(--color-orange-100);
    }
    
    .severity-indicator {
        display: inline-flex;
        align-items: center;
        gap: var(--space-2);
        padding: var(--space-1) var(--space-3);
        border-radius: var(--radius);
        font-size: var(--text-xs);
        font-weight: 600;
    }
    
    .severity-critical {
        background: var(--color-red-200);
        color: var(--color-red-900);
    }
    
    .severity-moderate {
        background: var(--color-orange-200);
        color: var(--color-orange-900);
    }
    
    .status-badge {
        display: inline-block;
        padding: var(--space-1) var(--space-2);
        border-radius: var(--radius);
        font-size: var(--text-xs);
        font-weight: 500;
    }
    
    .status-resolved {
        background: var(--color-green-100);
        color: var(--color-green-800);
    }
    
    .status-pending {
        background: var(--color-yellow-100);
        color: var(--color-yellow-800);
    }
</style>

{% if deficits %}
<div class="deficits-table">
    <table>
        <thead>
            <tr>
                <th>Date</th>
                <th>Salesperson</th>
                <th>Revenue Deficit</th>
                <th>Crate Deficit</th>
                <th>Severity</th>
                <th>Reason</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for return in deficits %}
            <tr class="{% if return.revenue_deficit > 500 or return.crates_deficit > 5 %}deficit-critical{% elif return.revenue_deficit > 0 or return.crates_deficit > 0 %}deficit-moderate{% endif %}">
                <td>{{ return.return_date|date:"M d, Y" }}</td>
                <td>
                    <strong>{{ return.dispatch.salesperson.name }}</strong><br>
                    <small style="color: var(--color-gray-500);">Dispatch: {{ return.dispatch.date|date:"M d, Y" }}</small>
                </td>
                <td style="font-weight: 700; {% if return.revenue_deficit > 500 %}color: var(--color-error);{% elif return.revenue_deficit > 0 %}color: var(--color-warning);{% else %}color: var(--color-success);{% endif %}">
                    {% if return.revenue_deficit > 0 %}
                        KES {{ return.revenue_deficit|floatformat:2 }}
                    {% else %}
                        <span style="color: var(--color-success);">‚úì None</span>
                    {% endif %}
                </td>
                <td style="font-weight: 700; {% if return.crates_deficit > 5 %}color: var(--color-error);{% elif return.crates_deficit > 0 %}color: var(--color-warning);{% else %}color: var(--color-success);{% endif %}">
                    {% if return.crates_deficit > 0 %}
                        {{ return.crates_deficit }} crate{{ return.crates_deficit|pluralize }}
                    {% else %}
                        <span style="color: var(--color-success);">‚úì None</span>
                    {% endif %}
                </td>
                <td>
                    {% if return.revenue_deficit > 500 or return.crates_deficit > 5 %}
                        <span class="severity-indicator severity-critical">
                            üî¥ CRITICAL
                        </span>
                    {% elif return.revenue_deficit > 0 or return.crates_deficit > 0 %}
                        <span class="severity-indicator severity-moderate">
                            üü† MODERATE
                        </span>
                    {% else %}
                        <span class="severity-indicator" style="background: var(--color-green-200); color: var(--color-green-900);">
                            ‚úÖ NONE
                        </span>
                    {% endif %}
                </td>
                <td>
                    {% if return.deficit_reason %}
                        {{ return.deficit_reason|truncatewords:10 }}
                    {% else %}
                        <em style="color: var(--color-gray-400);">No reason provided</em>
                    {% endif %}
                </td>
                <td>
                    {% if return.deficit_resolved %}
                        <span class="status-badge status-resolved">‚úÖ Resolved</span>
                    {% else %}
                        <span class="status-badge status-pending">‚è≥ Pending</span>
                    {% endif %}
                </td>
                <td>
                    <a href="{% url 'sales:return_detail' return.pk %}" class="btn btn--sm btn--primary">
                        üëÅÔ∏è View Details
                    </a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Summary Stats -->
<div style="margin-top: var(--space-6); padding: var(--space-4); background: var(--color-gray-50); border-radius: var(--radius);">
    <h4 style="margin-bottom: var(--space-3); color: var(--color-gray-700);">Deficit Summary</h4>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--space-4);">
        <div>
            <div style="font-size: var(--text-xs); color: var(--color-gray-600);">Total Returns with Deficits</div>
            <div style="font-size: var(--text-xl); font-weight: 700; color: var(--color-gray-900);">
                {{ deficits.count }}
            </div>
        </div>
        <div>
            <div style="font-size: var(--text-xs); color: var(--color-gray-600);">Total Revenue Deficit</div>
            <div style="font-size: var(--text-xl); font-weight: 700; color: var(--color-error);">
                KES {{ deficit_total|floatformat:2|default:"0.00" }}
            </div>
        </div>
        <div>
            <div style="font-size: var(--text-xs); color: var(--color-gray-600);">Total Crate Deficit</div>
            <div style="font-size: var(--text-xl); font-weight: 700; color: var(--color-warning);">
                {{ crate_deficit_total|default:0 }} crates
            </div>
        </div>
        <div>
            <div style="font-size: var(--text-xs); color: var(--color-gray-600);">Critical (Revenue >KES 500 or Crates >5)</div>
            <div style="font-size: var(--text-xl); font-weight: 700; color: var(--color-red-600);">
                {{ critical_count|default:0 }}
            </div>
        </div>
        <div>
            <div style="font-size: var(--text-xs); color: var(--color-gray-600);">Resolved</div>
            <div style="font-size: var(--text-xl); font-weight: 700; color: var(--color-success);">
                {{ resolved_count|default:0 }}
            </div>
        </div>
    </div>
</div>

<!-- Pagination -->
{% if is_paginated %}
<div style="margin-top: var(--space-6); display: flex; justify-content: center; gap: var(--space-2);">
    {% if page_obj.has_previous %}
    <a href="?tab=deficits&page={{ page_obj.previous_page_number }}&start_date={{ start_date|date:'Y-m-d' }}&end_date={{ end_date|date:'Y-m-d' }}&salesperson={{ selected_salesperson }}" class="btn btn--secondary">
        ‚Üê Previous
    </a>
    {% endif %}
    
    <span style="padding: var(--space-2) var(--space-4); color: var(--color-gray-600);">
        Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
    </span>
    
    {% if page_obj.has_next %}
    <a href="?tab=deficits&page={{ page_obj.next_page_number }}&start_date={{ start_date|date:'Y-m-d' }}&end_date={{ end_date|date:'Y-m-d' }}&salesperson={{ selected_salesperson }}" class="btn btn--secondary">
        Next ‚Üí
    </a>
    {% endif %}
</div>
{% endif %}

{% else %}
<div class="empty-message">
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
    </svg>
    <h3 style="margin-bottom: var(--space-2); color: var(--color-gray-700);">No deficits found</h3>
    <p style="color: var(--color-success);">‚úÖ Great! No deficits in the selected date range.</p>
</div>
{% endif %}
