{% extends 'accounts/base.html' %}

{% block title %}Record Sales Return - Chesanto Bakery{% endblock %}

{% block container_class %}container--wide{% endblock %}

{% block content %}
<style>
    .container--wide {
        max-width: 1000px;
    }
    
    /* Page Header */
    .page-header {
        margin-bottom: var(--spacing-8);
    }
    
    .page-header__title {
        font-size: 1.875rem;
        font-weight: 600;
        color: var(--gray-900);
        margin-bottom: var(--spacing-2);
    }
    
    .page-header__subtitle {
        font-size: 1rem;
        color: var(--gray-600);
    }
    
    /* Dispatch Info Card */
    .dispatch-info {
        background: var(--gray-50);
        border: 1px solid var(--gray-200);
        border-radius: 0.5rem;
        padding: var(--spacing-6);
        margin-bottom: var(--spacing-8);
    }
    
    .dispatch-info__title {
        font-size: 0.875rem;
        font-weight: 600;
        color: var(--gray-900);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: var(--spacing-4);
    }
    
    .dispatch-info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: var(--spacing-4);
    }
    
    .dispatch-info-item__label {
        display: block;
        font-size: 0.75rem;
        font-weight: 500;
        color: var(--gray-600);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: var(--spacing-1);
    }
    
    .dispatch-info-item__value {
        font-size: 1rem;
        font-weight: 600;
        color: var(--gray-900);
    }
    
    /* Form Sections */
    .form-section {
        background: white;
        border: 1px solid var(--gray-200);
        border-radius: 0.5rem;
        padding: var(--spacing-6);
        margin-bottom: var(--spacing-6);
        box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
    }
    
    .form-section__title {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--gray-900);
        margin-bottom: var(--spacing-6);
        padding-bottom: var(--spacing-4);
        border-bottom: 2px solid var(--gray-200);
    }
    
    /* Products Table */
    .products-table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: var(--spacing-6);
        background: white;
        border: 1px solid var(--gray-200);
        border-radius: 0.5rem;
        overflow: hidden;
    }
    
    .products-table thead {
        background: var(--gray-50);
    }
    
    .products-table th {
        padding: 1rem;
        text-align: left;
        font-size: 0.875rem;
        font-weight: 600;
        color: var(--gray-700);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        border-bottom: 1px solid var(--gray-200);
    }
    
    .products-table th:last-child {
        text-align: center;
    }
    
    .products-table tbody tr {
        border-bottom: 1px solid var(--gray-200);
    }
    
    .products-table tbody tr:last-child {
        border-bottom: none;
    }
    
    .products-table td {
        padding: 1rem;
    }
    
    .products-table td:last-child {
        text-align: center;
    }
    
    .product-name {
        font-weight: 500;
        color: var(--gray-900);
    }
    
    .dispatched-qty {
        font-size: 1rem;
        font-weight: 600;
        color: var(--gray-700);
    }
    
    .qty-input {
        width: 80px;
        text-align: center;
        padding: var(--spacing-2);
        border: 1px solid var(--gray-300);
        border-radius: 0.375rem;
        font-size: 0.875rem;
        transition: border-color 0.15s;
    }
    
    .qty-input:focus {
        outline: none;
        border-color: var(--blue-500);
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }
    
    .sold-qty {
        font-size: 1rem;
        font-weight: 600;
        color: var(--gray-900);
    }
    
    /* Return Summary */
    .return-summary {
        background: var(--blue-50);
        border: 1px solid var(--blue-200);
        border-radius: 0.5rem;
        padding: var(--spacing-6);
        margin-bottom: var(--spacing-6);
    }
    
    .return-summary__title {
        font-size: 1rem;
        font-weight: 600;
        color: var(--blue-900);
        margin-bottom: var(--spacing-4);
    }
    
    .return-summary-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: var(--spacing-4);
    }
    
    .return-summary-item__label {
        font-size: 0.75rem;
        color: var(--blue-700);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: var(--spacing-1);
    }
    
    .return-summary-item__value {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--blue-900);
    }
    
    /* Commission Preview (Optional/Small) */
    .commission-preview {
        background: var(--gray-50);
        border: 1px solid var(--gray-200);
        border-radius: 0.5rem;
        padding: var(--spacing-4);
        margin-bottom: var(--spacing-6);
    }
    
    .commission-preview__title {
        font-size: 0.875rem;
        font-weight: 600;
        color: var(--gray-700);
        margin-bottom: var(--spacing-3);
    }
    
    .commission-preview-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: var(--spacing-3);
    }
    
    .commission-preview-item__label {
        font-size: 0.75rem;
        color: var(--gray-600);
        margin-bottom: var(--spacing-1);
    }
    
    .commission-preview-item__value {
        font-size: 1rem;
        font-weight: 600;
        color: var(--gray-900);
    }
    
    /* Alert Messages */
    .alert {
        padding: var(--spacing-4);
        border-radius: 0.375rem;
        margin-bottom: var(--spacing-4);
        border: 1px solid;
        font-size: 0.875rem;
    }
    
    .alert--warning {
        background: var(--orange-50);
        border-color: var(--orange-200);
        color: var(--orange-800);
    }
    
    .alert--error {
        background: var(--red-50);
        border-color: var(--red-200);
        color: var(--red-800);
    }
    
    .alert--info {
        background: var(--blue-50);
        border-color: var(--blue-200);
        color: var(--blue-800);
    }
    
    /* Form Actions */
    .form-actions {
        display: flex;
        justify-content: flex-end;
        gap: var(--spacing-4);
        padding-top: var(--spacing-6);
        border-top: 1px solid var(--gray-200);
    }
    
    /* Helper Text */
    .helper-text {
        background: var(--blue-50);
        border: 1px solid var(--blue-200);
        border-radius: 0.375rem;
        padding: var(--spacing-4);
        margin-bottom: var(--spacing-6);
        font-size: 0.875rem;
        color: var(--blue-800);
    }
</style>

<!-- Page Header -->
<div class="page-header">
    <h1 class="page-header__title">Record Sales Return</h1>
    <p class="page-header__subtitle">Record what the salesperson returned from their dispatch</p>
</div>

<!-- Dispatch Info -->
<div class="dispatch-info">
    <h2 class="dispatch-info__title">Dispatch #{{ dispatch.id }} - {{ dispatch.salesperson.name }}</h2>
    <div class="dispatch-info-grid">
        <div class="dispatch-info-item">
            <span class="dispatch-info-item__label">Dispatch Date</span>
            <span class="dispatch-info-item__value">{{ dispatch.date|date:"M d, Y" }}</span>
        </div>
        <div class="dispatch-info-item">
            <span class="dispatch-info-item__label">Salesperson</span>
            <span class="dispatch-info-item__value">{{ dispatch.salesperson.name }}</span>
        </div>
        <div class="dispatch-info-item">
            <span class="dispatch-info-item__label">Crates Dispatched</span>
            <span class="dispatch-info-item__value">{{ dispatch.crates_dispatched }} crates</span>
        </div>
        <div class="dispatch-info-item">
            <span class="dispatch-info-item__label">Expected Revenue</span>
            <span class="dispatch-info-item__value">KES {{ dispatch.expected_revenue|floatformat:2 }}</span>
        </div>
    </div>
</div>

<!-- Helper Text -->
<div class="helper-text">
    <strong>How to record:</strong> Enter the cash collected and specify which products were sold, returned, or damaged. Crates will be handled separately after submission.
</div>

<!-- Form -->
<form method="post" id="salesReturnForm">
    {% csrf_token %}
    
    <!-- Return Information -->
    <div class="form-section">
        <h2 class="form-section__title">Return Information</h2>
        
        <div class="grid grid--cols-2 gap-4">
            <div class="form-group">
                <label for="return_date" class="form-label">Return Date *</label>
                <input type="date" class="form-control" id="return_date" name="return_date" 
                       value="{{ today|date:'Y-m-d' }}" required>
            </div>
            
            <div class="form-group">
                <label for="return_time" class="form-label">Return Time</label>
                <input type="time" class="form-control" id="return_time" name="return_time"
                       value="17:00">
            </div>
            
            <div class="form-group">
                <label for="cash_returned" class="form-label">Cash Collected (KES) *</label>
                <input type="number" class="form-control" id="cash_returned" name="cash_returned" 
                       step="0.01" min="0" placeholder="0.00" required>
                <span class="form-help">Total cash from sales</span>
            </div>
            
            <div class="form-group">
                <label for="crates_returned" class="form-label">Crates Returned *</label>
                <input type="number" class="form-control" id="crates_returned" name="crates_returned" 
                       value="{{ dispatch.crates_dispatched }}" min="0" max="{{ dispatch.crates_dispatched }}" required>
                <span class="form-help">Max: {{ dispatch.crates_dispatched }} crates</span>
            </div>
        </div>
    </div>

<!-- Form -->
<form method="post" id="salesReturnForm">
    {% csrf_token %}
    
    <!-- Step 1: Return Information -->
    <div class="form-section">
        <div class="form-section__header">
            <span class="form-section__number">1</span>
            <h2 class="form-section__title">Return Information</h2>
        </div>
        
        <div class="return-info-grid">
            <div class="form-group">
                <label for="return_date" class="form-label">Return Date *</label>
                <input type="date" class="form-control" id="return_date" name="return_date" 
                       value="{{ today|date:'Y-m-d' }}" required>
            </div>
            
            <div class="form-group">
                <label for="return_time" class="form-label">Return Time</label>
                <input type="time" class="form-control" id="return_time" name="return_time"
                       value="17:00">
                <span class="form-help">When did the salesperson return?</span>
            </div>
            
            <div class="form-group">
                <label for="crates_returned" class="form-label">Crates Returned *</label>
                <input type="number" class="form-control" id="crates_returned" name="crates_returned" 
                       value="{{ dispatch.crates_dispatched }}" min="0" max="{{ dispatch.crates_dispatched }}" required>
                <span class="form-help">Max: {{ dispatch.crates_dispatched }} crates</span>
                <!-- Real-time feedback for crates -->
                <div id="crateFeedback" style="margin-top: 0.5rem; padding: 0.75rem; border-radius: 0.375rem; display: none; font-size: 0.875rem; font-weight: 500;"></div>
            </div>
            
            <div class="form-group">
                <label for="cash_returned" class="form-label">Cash Returned (KES) *</label>
                <input type="number" class="form-control" id="cash_returned" name="cash_returned" 
                       step="0.01" min="0" placeholder="0.00" required>
                <span class="form-help">Total cash collected from sales</span>
                <!-- Real-time feedback for cash -->
                <div id="cashFeedback" style="margin-top: 0.5rem; padding: 0.75rem; border-radius: 0.375rem; display: none; font-size: 0.875rem; font-weight: 500;"></div>
            </div>
        </div>
    </div>
    
    <!-- Products Breakdown -->
    <div class="form-section">
        <h2 class="form-section__title">Products Breakdown</h2>
        
        <table class="products-table">
            <thead>
                <tr>
                    <th>Product</th>
                    <th style="text-align: center;">Dispatched</th>
                    <th style="text-align: center;">Returned</th>
                    <th style="text-align: center;">Damaged</th>
                    <th style="text-align: center;">Sold</th>
                </tr>
            </thead>
            <tbody>
                {% for item in items %}
                <tr data-product-id="{{ item.product.id }}" 
                    data-dispatched="{{ item.quantity }}"
                    data-price="{{ item.product.price_per_packet }}">
                    <td class="product-name">{{ item.product.name }}</td>
                    <td style="text-align: center;"><span class="dispatched-qty">{{ item.quantity }}</span></td>
                    <td style="text-align: center;">
                        <input type="number" class="qty-input product-input" 
                               name="units_returned_{{ item.product.id }}" 
                               id="units_returned_{{ item.product.id }}"
                               min="0" max="{{ item.quantity }}" value="0"
                               data-type="returned">
                    </td>
                    <td style="text-align: center;">
                        <input type="number" class="qty-input product-input" 
                               name="units_damaged_{{ item.product.id }}" 
                               id="units_damaged_{{ item.product.id }}"
                               min="0" max="{{ item.quantity }}" value="0"
                               data-type="damaged">
                    </td>
                    <td style="text-align: center;">
                        <span class="sold-qty" id="sold_{{ item.product.id }}">{{ item.quantity }}</span>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <!-- Return Summary -->
    <div class="return-summary">
        <h3 class="return-summary__title">Return Summary</h3>
        <div class="return-summary-grid">
            <div class="return-summary-item">
                <div class="return-summary-item__label">Total Products Returned</div>
                <div class="return-summary-item__value" id="totalReturned">0</div>
            </div>
            <div class="return-summary-item">
                <div class="return-summary-item__label">Total Products Sold</div>
                <div class="return-summary-item__value" id="totalSold">0</div>
            </div>
            <div class="return-summary-item">
                <div class="return-summary-item__label">Cash Collected</div>
                <div class="return-summary-item__value" id="cashSummary">KES 0.00</div>
            </div>
            <div class="return-summary-item">
                <div class="return-summary-item__label">Crates Returned</div>
                <div class="return-summary-item__value" id="cratesSummary">{{ dispatch.crates_dispatched }}</div>
            </div>
        </div>
    </div>
    
    <!-- Deficit Reason (Optional) -->
    <div class="form-section">
        <h2 class="form-section__title">Deficit Reason (Optional)</h2>
        
        <div class="form-group">
            <label for="deficit_reason" class="form-label">Explain any issues</label>
            <textarea class="form-control" id="deficit_reason" name="deficit_reason" 
                      rows="3" placeholder="E.g., Expired stock, damaged during transport, theft, etc."></textarea>
            <span class="form-help">Only fill this if there were problems with the sales</span>
        </div>
    </div>
    
    <!-- Commission Preview (Optional/Small) -->
    <div class="commission-preview">
        <h3 class="commission-preview__title">Commission Preview</h3>
        <div class="commission-preview-grid">
            <div class="commission-preview-item">
                <div class="commission-preview-item__label">Units Sold</div>
                <div class="commission-preview-item__value" id="commissionUnits">0</div>
            </div>
            <div class="commission-preview-item">
                <div class="commission-preview-item__label">Per-Unit</div>
                <div class="commission-preview-item__value" id="commissionPerUnit">KES 0.00</div>
            </div>
            <div class="commission-preview-item">
                <div class="commission-preview-item__label">Bonus</div>
                <div class="commission-preview-item__value" id="commissionBonus">KES 0.00</div>
            </div>
            <div class="commission-preview-item">
                <div class="commission-preview-item__label">Total</div>
                <div class="commission-preview-item__value" id="commissionTotal">KES 0.00</div>
            </div>
        </div>
    </div>
    
    <!-- Alerts -->
    <div class="alert alert--error" id="revenueDeficitAlert" style="display: none;">
        <strong>Revenue Deficit:</strong> <span id="revenueDeficitText"></span>
    </div>
    
    <div class="alert alert--warning" id="crateDeficitAlert" style="display: none;">
        <strong>Crate Deficit:</strong> <span id="crateDeficitText"></span>
    </div>
    
    <!-- Form Actions -->
    <div class="form-actions">
        <a href="{% url 'sales:dispatch_detail' dispatch.id %}" class="btn btn--secondary">Cancel</a>
        <button type="submit" class="btn btn--primary">Record Return</button>
    </div>
</form>

<script>
// Simplified Sales Return Calculator
(function() {
    const form = document.getElementById('salesReturnForm');
    const cashInput = document.getElementById('cash_returned');
    const cratesReturnedInput = document.getElementById('crates_returned');
    const productInputs = document.querySelectorAll('.product-input');
    
    // Constants
    const PER_UNIT_RATE = parseFloat('{{ commission_settings.per_unit_commission|default:"5" }}');
    const BONUS_THRESHOLD = parseFloat('{{ commission_settings.bonus_threshold|default:"35000" }}');
    const BONUS_RATE = parseFloat('{{ commission_settings.bonus_percentage|default:"7" }}') / 100;
    const expectedRevenue = parseFloat('{{ dispatch.expected_revenue|default:0 }}');
    const cratesDispatched = parseInt('{{ dispatch.crates_dispatched|default:0 }}');
    
    function calculateReturn() {
        let totalReturned = 0;
        let totalSold = 0;
        let totalDamaged = 0;
        
        // Calculate for each product
        document.querySelectorAll('tr[data-product-id]').forEach(row => {
            const productId = row.dataset.productId;
            const dispatched = parseInt(row.dataset.dispatched);
            
            const returned = parseInt(document.getElementById(`units_returned_${productId}`).value) || 0;
            const damaged = parseInt(document.getElementById(`units_damaged_${productId}`).value) || 0;
            const sold = Math.max(0, dispatched - returned - damaged);
            
            // Update sold display
            const soldElement = document.getElementById(`sold_${productId}`);
            soldElement.textContent = sold;
            
            totalReturned += returned;
            totalSold += sold;
            totalDamaged += damaged;
        });
        
        // Get cash and crates
        const cashReturned = parseFloat(cashInput.value) || 0;
        const cratesReturned = parseInt(cratesReturnedInput.value) || 0;
        
        // Calculate commission (simplified)
        const perUnitCommission = totalSold * PER_UNIT_RATE;
        let bonusCommission = 0;
        if (cashReturned > BONUS_THRESHOLD) {
            bonusCommission = (cashReturned - BONUS_THRESHOLD) * BONUS_RATE;
        }
        const totalCommission = perUnitCommission + bonusCommission;
        
        // Update summary
        document.getElementById('totalReturned').textContent = totalReturned;
        document.getElementById('totalSold').textContent = totalSold;
        document.getElementById('cashSummary').textContent = `KES ${cashReturned.toFixed(2)}`;
        document.getElementById('cratesSummary').textContent = cratesReturned;
        
        // Update commission preview
        document.getElementById('commissionUnits').textContent = totalSold;
        document.getElementById('commissionPerUnit').textContent = `KES ${perUnitCommission.toFixed(2)}`;
        document.getElementById('commissionBonus').textContent = `KES ${bonusCommission.toFixed(2)}`;
        document.getElementById('commissionTotal').textContent = `KES ${totalCommission.toFixed(2)}`;
        
        // Show alerts for deficits
        const revenueDeficit = Math.max(0, expectedRevenue - cashReturned);
        const crateDeficit = cratesDispatched - cratesReturned;
        
        const revenueAlert = document.getElementById('revenueDeficitAlert');
        const revenueText = document.getElementById('revenueDeficitText');
        if (revenueDeficit > 0) {
            revenueAlert.style.display = 'block';
            revenueText.textContent = `KES ${revenueDeficit.toFixed(2)} deficit (Expected: KES ${expectedRevenue.toFixed(2)})`;
        } else {
            revenueAlert.style.display = 'none';
        }
        
        const crateAlert = document.getElementById('crateDeficitAlert');
        const crateText = document.getElementById('crateDeficitText');
        if (crateDeficit > 0) {
            crateAlert.style.display = 'block';
            crateText.textContent = `${crateDeficit} crate${crateDeficit > 1 ? 's' : ''} missing`;
        } else {
            crateAlert.style.display = 'none';
        }
    }
    
    // Event listeners
    cashInput.addEventListener('input', calculateReturn);
    cratesReturnedInput.addEventListener('input', calculateReturn);
    productInputs.forEach(input => {
        input.addEventListener('input', calculateReturn);
    });
    
    // Initial calculation
    calculateReturn();
    
    // Form validation
    form.addEventListener('submit', function(e) {
        let errors = [];
        
        // Validate products
        document.querySelectorAll('tr[data-product-id]').forEach(row => {
            const productName = row.querySelector('.product-name').textContent;
            const dispatched = parseInt(row.dataset.dispatched);
            const returned = parseInt(row.querySelector('[data-type="returned"]').value) || 0;
            const damaged = parseInt(row.querySelector('[data-type="damaged"]').value) || 0;
            
            if (returned + damaged > dispatched) {
                errors.push(`${productName}: Returned (${returned}) + Damaged (${damaged}) exceeds Dispatched (${dispatched})`);
            }
        });
        
        // Validate cash
        if (!cashInput.value || parseFloat(cashInput.value) < 0) {
            errors.push('Please enter the cash collected amount');
        }
        
        if (errors.length > 0) {
            e.preventDefault();
            alert('Please fix the following errors:\n\n' + errors.join('\n'));
        }
    });
})();
</script>

{% endblock %}
