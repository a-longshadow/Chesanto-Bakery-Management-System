{% extends 'accounts/base.html' %}

{% block title %}Record Sales Return - Chesanto Bakery{% endblock %}

{% block container_class %}container--wide{% endblock %}

{% block content %}
<style>
    .container--wide {
        max-width: 1200px;
    }
    
    /* Page Header */
    .page-header {
        margin-bottom: var(--spacing-8);
    }
    
    .page-header__title {
        font-size: 1.875rem;
        font-weight: 600;
        color: var(--gray-900);
        margin-bottom: var(--spacing-2);
    }
    
    .page-header__subtitle {
        font-size: 1rem;
        color: var(--gray-600);
    }
    
    /* Dispatch Info Card */
    .info-card {
        background: var(--blue-50);
        border: 1px solid var(--blue-200);
        border-radius: 0.5rem;
        padding: var(--spacing-6);
        margin-bottom: var(--spacing-8);
    }
    
    .info-card__title {
        font-size: 0.875rem;
        font-weight: 600;
        color: var(--blue-900);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: var(--spacing-4);
    }
    
    .info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: var(--spacing-4);
    }
    
    .info-item__label {
        display: block;
        font-size: 0.75rem;
        font-weight: 500;
        color: var(--gray-600);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: var(--spacing-1);
    }
    
    .info-item__value {
        font-size: 1rem;
        font-weight: 600;
        color: var(--gray-900);
    }
    
    /* Form Sections */
    .form-section {
        margin-bottom: var(--spacing-8);
    }
    
    .form-section__header {
        display: flex;
        align-items: center;
        gap: var(--spacing-2);
        margin-bottom: var(--spacing-6);
        padding-bottom: var(--spacing-3);
        border-bottom: 2px solid var(--gray-200);
    }
    
    .form-section__number {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 2rem;
        height: 2rem;
        background: var(--blue-600);
        color: white;
        font-weight: 600;
        border-radius: 50%;
        font-size: 1rem;
    }
    
    .form-section__title {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--gray-900);
    }
    
    /* Products Table */
    .products-table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: var(--spacing-6);
        background: white;
        border-radius: 0.5rem;
        overflow: hidden;
        box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
    }
    
    .products-table thead {
        background: var(--gray-50);
    }
    
    .products-table th {
        padding: var(--spacing-4);
        text-align: left;
        font-size: 0.75rem;
        font-weight: 600;
        color: var(--gray-700);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        border-bottom: 2px solid var(--gray-200);
    }
    
    .products-table th:last-child,
    .products-table td:last-child {
        text-align: center;
    }
    
    .products-table tbody tr {
        border-bottom: 1px solid var(--gray-200);
        transition: background-color 0.15s;
    }
    
    .products-table tbody tr:hover {
        background: var(--gray-50);
    }
    
    .products-table tbody tr:last-child {
        border-bottom: none;
    }
    
    .products-table td {
        padding: var(--spacing-4);
    }
    
    .product-name {
        font-weight: 500;
        color: var(--gray-900);
    }
    
    .dispatched-qty {
        font-size: 1.125rem;
        font-weight: 600;
        color: var(--blue-600);
    }
    
    .qty-input {
        width: 80px;
        text-align: center;
        padding: var(--spacing-2);
        border: 1px solid var(--gray-300);
        border-radius: 0.375rem;
        font-size: 0.875rem;
        font-weight: 500;
        transition: all 0.15s;
    }
    
    .qty-input:focus {
        outline: none;
        border-color: var(--blue-500);
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }
    
    .sold-badge {
        display: inline-block;
        padding: var(--spacing-2) var(--spacing-4);
        background: var(--green-100);
        color: var(--green-700);
        font-weight: 600;
        font-size: 1rem;
        border-radius: 0.375rem;
        min-width: 60px;
        text-align: center;
    }
    
    /* Return Info Grid */
    .return-info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: var(--spacing-4);
        margin-bottom: var(--spacing-6);
    }
    
    /* Commission Preview Card */
    .commission-card {
        background: linear-gradient(135deg, var(--blue-50) 0%, var(--green-50) 100%);
        border: 2px solid var(--blue-200);
        border-radius: 0.5rem;
        padding: var(--spacing-6);
        margin-top: var(--spacing-8);
    }
    
    .commission-card__title {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--gray-900);
        margin-bottom: var(--spacing-6);
        text-align: center;
    }
    
    .commission-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: var(--spacing-4);
    }
    
    .commission-item {
        background: white;
        padding: var(--spacing-4);
        border-radius: 0.375rem;
        box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
    }
    
    .commission-item--total {
        grid-column: 1 / -1;
        background: var(--green-100);
        border: 2px solid var(--green-500);
    }
    
    .commission-item__label {
        font-size: 0.75rem;
        color: var(--gray-600);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: var(--spacing-1);
    }
    
    .commission-item__value {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--gray-900);
    }
    
    .commission-item--total .commission-item__value {
        font-size: 1.875rem;
        color: var(--green-700);
    }
    
    /* Alert Messages */
    .alert-card {
        display: none;
        padding: var(--spacing-4);
        border-radius: 0.5rem;
        margin-top: var(--spacing-6);
        border: 2px solid;
    }
    
    .alert-card.show {
        display: block;
    }
    
    .alert-card__title {
        font-size: 1rem;
        font-weight: 600;
        margin-bottom: var(--spacing-2);
    }
    
    .alert-card__text {
        font-size: 0.875rem;
    }
    
    .alert-card--warning {
        background: var(--orange-50);
        border-color: var(--orange-500);
    }
    
    .alert-card--warning .alert-card__title {
        color: var(--orange-900);
    }
    
    .alert-card--warning .alert-card__text {
        color: var(--orange-800);
    }
    
    .alert-card--error {
        background: var(--red-50);
        border-color: var(--red-600);
    }
    
    .alert-card--error .alert-card__title {
        color: var(--red-900);
    }
    
    .alert-card--error .alert-card__text {
        color: var(--red-800);
    }
    
    .alert-card--info {
        background: var(--cyan-50);
        border-color: var(--cyan-500);
    }
    
    .alert-card--info .alert-card__title {
        color: var(--cyan-900);
    }
    
    .alert-card--info .alert-card__text {
        color: var(--cyan-800);
    }
    
    /* Form Actions */
    .form-actions {
        display: flex;
        justify-content: flex-end;
        gap: var(--spacing-4);
        padding-top: var(--spacing-8);
        border-top: 2px solid var(--gray-200);
    }
    
    /* Helper Text */
    .helper-text {
        display: flex;
        align-items: center;
        gap: var(--spacing-2);
        padding: var(--spacing-4);
        background: var(--cyan-50);
        border: 1px solid var(--cyan-200);
        border-radius: 0.375rem;
        margin-bottom: var(--spacing-6);
        font-size: 0.875rem;
        color: var(--cyan-900);
    }
    
    .helper-text__icon {
        font-size: 1.25rem;
    }
</style>

<!-- Page Header -->
<div class="page-header">
    <h1 class="page-header__title">Record Sales Return</h1>
    <p class="page-header__subtitle">Enter what the salesperson returned to calculate commission and track deficits</p>
</div>

<!-- Dispatch Info -->
<div class="info-card">
    <h2 class="info-card__title">Dispatch #{{ dispatch.id }} - {{ dispatch.salesperson.name }}</h2>
    <div class="info-grid">
        <div class="info-item">
            <span class="info-item__label">Dispatch Date</span>
            <span class="info-item__value">{{ dispatch.date|date:"M d, Y" }}</span>
        </div>
        <div class="info-item">
            <span class="info-item__label">Salesperson</span>
            <span class="info-item__value">{{ dispatch.salesperson.name }}</span>
        </div>
        <div class="info-item">
            <span class="info-item__label">Crates Dispatched</span>
            <span class="info-item__value">{{ dispatch.crates_dispatched }} crates</span>
        </div>
        <div class="info-item">
            <span class="info-item__label">Expected Revenue</span>
            <span class="info-item__value">KES {{ dispatch.expected_revenue|floatformat:2 }}</span>
        </div>
    </div>
</div>

<!-- Helper Text -->
<div class="helper-text">
    <span class="helper-text__icon">üí°</span>
    <div>
        <strong>How to use:</strong> 
        Enter what was returned and damaged. The system will automatically calculate what was sold, 
        commission earned, and any deficits. Items left at 0 are assumed to be fully sold.
    </div>
</div>

<!-- Form -->
<form method="post" id="salesReturnForm">
    {% csrf_token %}
    
    <!-- Step 1: Return Information -->
    <div class="form-section">
        <div class="form-section__header">
            <span class="form-section__number">1</span>
            <h2 class="form-section__title">Return Information</h2>
        </div>
        
        <div class="return-info-grid">
            <div class="form-group">
                <label for="return_date" class="form-label">Return Date *</label>
                <input type="date" class="form-control" id="return_date" name="return_date" 
                       value="{{ today|date:'Y-m-d' }}" required>
            </div>
            
            <div class="form-group">
                <label for="return_time" class="form-label">Return Time</label>
                <input type="time" class="form-control" id="return_time" name="return_time"
                       value="17:00">
                <span class="form-help">When did the salesperson return?</span>
            </div>
            
            <div class="form-group">
                <label for="crates_returned" class="form-label">Crates Returned *</label>
                <input type="number" class="form-control" id="crates_returned" name="crates_returned" 
                       value="{{ dispatch.crates_dispatched }}" min="0" max="{{ dispatch.crates_dispatched }}" required>
                <span class="form-help">Max: {{ dispatch.crates_dispatched }} crates</span>
            </div>
            
            <div class="form-group">
                <label for="cash_returned" class="form-label">Cash Returned (KES) *</label>
                <input type="number" class="form-control" id="cash_returned" name="cash_returned" 
                       step="0.01" min="0" placeholder="0.00" required>
                <span class="form-help">Total cash collected from sales</span>
            </div>
        </div>
    </div>
    
    <!-- Step 2: Products Breakdown -->
    <div class="form-section">
        <div class="form-section__header">
            <span class="form-section__number">2</span>
            <h2 class="form-section__title">Products Breakdown</h2>
        </div>
        
        <table class="products-table">
            <thead>
                <tr>
                    <th>Product</th>
                    <th style="text-align: center;">Dispatched</th>
                    <th style="text-align: center;">Returned</th>
                    <th style="text-align: center;">Damaged</th>
                    <th style="text-align: center;">Sold</th>
                </tr>
            </thead>
            <tbody>
                {% for item in items %}
                <tr data-product-id="{{ item.product.id }}" 
                    data-dispatched="{{ item.quantity }}"
                    data-price="{{ item.product.price_per_packet }}">
                    <td class="product-name">{{ item.product.name }}</td>
                    <td style="text-align: center;"><span class="dispatched-qty">{{ item.quantity }}</span></td>
                    <td style="text-align: center;">
                        <input type="number" class="qty-input product-input" 
                               name="units_returned_{{ item.product.id }}" 
                               id="units_returned_{{ item.product.id }}"
                               min="0" max="{{ item.quantity }}" value="0"
                               data-type="returned">
                    </td>
                    <td style="text-align: center;">
                        <input type="number" class="qty-input product-input" 
                               name="units_damaged_{{ item.product.id }}" 
                               id="units_damaged_{{ item.product.id }}"
                               min="0" max="{{ item.quantity }}" value="0"
                               data-type="damaged">
                    </td>
                    <td style="text-align: center;">
                        <span class="sold-badge" id="sold_{{ item.product.id }}">{{ item.quantity }}</span>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <!-- Step 3: Deficit Reason (Optional) -->
    <div class="form-section">
        <div class="form-section__header">
            <span class="form-section__number">3</span>
            <h2 class="form-section__title">Deficit Reason (Optional)</h2>
        </div>
        
        <div class="form-group">
            <label for="deficit_reason" class="form-label">Explain any deficit</label>
            <textarea class="form-control" id="deficit_reason" name="deficit_reason" 
                      rows="3" placeholder="E.g., Expired stock, damaged during transport, theft, etc."></textarea>
            <span class="form-help">Only fill this if there's a revenue or product deficit</span>
        </div>
    </div>
    
    <!-- Commission Preview -->
    <div class="commission-card">
        <h3 class="commission-card__title">üí∞ Commission Calculation</h3>
        
        <div class="commission-grid">
            <div class="commission-item">
                <div class="commission-item__label">Units Sold</div>
                <div class="commission-item__value" id="totalUnitsSold">0</div>
            </div>
            
            <div class="commission-item">
                <div class="commission-item__label">Per-Unit Commission</div>
                <div class="commission-item__value" id="perUnitCommission">KES 0.00</div>
            </div>
            
            <div class="commission-item">
                <div class="commission-item__label">Revenue from Sales</div>
                <div class="commission-item__value" id="actualRevenue">KES 0.00</div>
            </div>
            
            <div class="commission-item">
                <div class="commission-item__label">Bonus (7% above KES 35K)</div>
                <div class="commission-item__value" id="bonusCommission">KES 0.00</div>
            </div>
            
            <div class="commission-item commission-item--total">
                <div class="commission-item__label">Total Commission</div>
                <div class="commission-item__value" id="totalCommission">KES 0.00</div>
            </div>
        </div>
    </div>
    
    <!-- Revenue Deficit Alert -->
    <div class="alert-card alert-card--error" id="revenueDeficitAlert">
        <div class="alert-card__title">‚ö†Ô∏è Revenue Deficit Detected</div>
        <div class="alert-card__text" id="revenueDeficitText"></div>
    </div>
    
    <!-- Crate Deficit Alert -->
    <div class="alert-card alert-card--warning" id="crateDeficitAlert">
        <div class="alert-card__title">üì¶ Crate Deficit Detected</div>
        <div class="alert-card__text" id="crateDeficitText"></div>
    </div>
    
    <!-- Crate Excess Alert -->
    <div class="alert-card alert-card--info" id="crateExcessAlert">
        <div class="alert-card__title">üì¶ Extra Crates Returned</div>
        <div class="alert-card__text" id="crateExcessText"></div>
    </div>
    
    <!-- Form Actions -->
    <div class="form-actions">
        <a href="{% url 'sales:dispatch_detail' dispatch.id %}" class="btn btn--secondary">Cancel</a>
        <button type="submit" class="btn btn--primary btn--lg">‚úÖ Submit Return & Calculate Commission</button>
    </div>
</form>

<script>
// Sales Return Calculator
(function() {
    const form = document.getElementById('salesReturnForm');
    const cashInput = document.getElementById('cash_returned');
    const cratesReturnedInput = document.getElementById('crates_returned');
    const productInputs = document.querySelectorAll('.product-input');
    
    // Constants
    const PER_UNIT_RATE = 5;
    const BONUS_THRESHOLD = 35000;
    const BONUS_RATE = 0.07;
    const expectedRevenue = parseFloat('{{ dispatch.expected_revenue|default:0 }}');
    const cratesDispatched = parseInt('{{ dispatch.crates_dispatched|default:0 }}');
    
    function calculateSalesReturn() {
        let totalUnitsSold = 0;
        let calculatedRevenue = 0;
        
        // Calculate for each product
        document.querySelectorAll('tr[data-product-id]').forEach(row => {
            const productId = row.dataset.productId;
            const dispatched = parseInt(row.dataset.dispatched);
            const price = parseFloat(row.dataset.price);
            
            const returned = parseInt(document.getElementById(`units_returned_${productId}`).value) || 0;
            const damaged = parseInt(document.getElementById(`units_damaged_${productId}`).value) || 0;
            const sold = Math.max(0, dispatched - returned - damaged);
            
            // Update sold display
            const soldElement = document.getElementById(`sold_${productId}`);
            soldElement.textContent = sold;
            
            // Color code based on performance
            if (sold === dispatched) {
                soldElement.style.background = 'var(--green-100)';
                soldElement.style.color = 'var(--green-700)';
            } else if (sold > 0) {
                soldElement.style.background = 'var(--blue-100)';
                soldElement.style.color = 'var(--blue-700)';
            } else {
                soldElement.style.background = 'var(--gray-100)';
                soldElement.style.color = 'var(--gray-600)';
            }
            
            totalUnitsSold += sold;
            calculatedRevenue += sold * price;
        });
        
        // Get cash returned
        const cashReturned = parseFloat(cashInput.value) || 0;
        
        // Calculate commission
        const perUnitCommission = totalUnitsSold * PER_UNIT_RATE;
        let bonusCommission = 0;
        if (cashReturned > BONUS_THRESHOLD) {
            bonusCommission = (cashReturned - BONUS_THRESHOLD) * BONUS_RATE;
        }
        const totalCommission = perUnitCommission + bonusCommission;
        
        // Calculate deficits
        const revenueDeficit = Math.max(0, expectedRevenue - cashReturned);
        const cratesReturned = parseInt(cratesReturnedInput.value) || 0;
        const crateDeficit = cratesDispatched - cratesReturned;
        
        // Update UI
        document.getElementById('totalUnitsSold').textContent = totalUnitsSold;
        document.getElementById('perUnitCommission').textContent = `KES ${perUnitCommission.toFixed(2)}`;
        document.getElementById('actualRevenue').textContent = `KES ${calculatedRevenue.toFixed(2)}`;
        document.getElementById('bonusCommission').textContent = `KES ${bonusCommission.toFixed(2)}`;
        document.getElementById('totalCommission').textContent = `KES ${totalCommission.toFixed(2)}`;
        
        // Show/hide revenue deficit alert
        const revenueAlert = document.getElementById('revenueDeficitAlert');
        const revenueText = document.getElementById('revenueDeficitText');
        if (revenueDeficit > 0) {
            revenueAlert.classList.add('show');
            if (revenueDeficit > 500) {
                revenueText.innerHTML = `<strong>KES ${revenueDeficit.toFixed(2)}</strong> revenue deficit. Expected: KES ${expectedRevenue.toFixed(2)}, Received: KES ${cashReturned.toFixed(2)}. <strong>CEO will be alerted.</strong>`;
            } else {
                revenueText.innerHTML = `<strong>KES ${revenueDeficit.toFixed(2)}</strong> revenue deficit. Expected: KES ${expectedRevenue.toFixed(2)}, Received: KES ${cashReturned.toFixed(2)}.`;
            }
        } else {
            revenueAlert.classList.remove('show');
        }
        
        // Show/hide crate alerts
        const crateAlert = document.getElementById('crateDeficitAlert');
        const crateText = document.getElementById('crateDeficitText');
        const excessAlert = document.getElementById('crateExcessAlert');
        const excessText = document.getElementById('crateExcessText');
        
        if (crateDeficit > 0) {
            crateAlert.classList.add('show');
            excessAlert.classList.remove('show');
            if (crateDeficit > 5) {
                crateText.innerHTML = `<strong>${crateDeficit} crates missing!</strong> Dispatched: ${cratesDispatched}, Returned: ${cratesReturned}. <strong>Accountant will be alerted.</strong>`;
                crateAlert.classList.remove('alert-card--warning');
                crateAlert.classList.add('alert-card--error');
            } else {
                crateText.innerHTML = `<strong>${crateDeficit} crates missing.</strong> Dispatched: ${cratesDispatched}, Returned: ${cratesReturned}. Please recover these crates.`;
                crateAlert.classList.remove('alert-card--error');
                crateAlert.classList.add('alert-card--warning');
            }
        } else if (crateDeficit < 0) {
            excessAlert.classList.add('show');
            crateAlert.classList.remove('show');
            excessText.innerHTML = `<strong>${Math.abs(crateDeficit)} extra crates</strong> returned. Dispatched: ${cratesDispatched}, Returned: ${cratesReturned}. Please verify count.`;
        } else {
            crateAlert.classList.remove('show');
            excessAlert.classList.remove('show');
        }
    }
    
    // Event listeners
    cashInput.addEventListener('input', calculateSalesReturn);
    cratesReturnedInput.addEventListener('input', calculateSalesReturn);
    productInputs.forEach(input => {
        input.addEventListener('input', function() {
            // Auto-calculate cash if not entered
            if (!cashInput.value || cashInput.value === '0') {
                let autoRevenue = 0;
                document.querySelectorAll('tr[data-product-id]').forEach(row => {
                    const productId = row.dataset.productId;
                    const dispatched = parseInt(row.dataset.dispatched);
                    const price = parseFloat(row.dataset.price);
                    const returned = parseInt(document.getElementById(`units_returned_${productId}`).value) || 0;
                    const damaged = parseInt(document.getElementById(`units_damaged_${productId}`).value) || 0;
                    const sold = Math.max(0, dispatched - returned - damaged);
                    autoRevenue += sold * price;
                });
                cashInput.value = autoRevenue.toFixed(2);
            }
            calculateSalesReturn();
        });
    });
    
    // Initial calculation
    calculateSalesReturn();
    
    // Form validation
    form.addEventListener('submit', function(e) {
        let errors = [];
        
        // Validate products
        document.querySelectorAll('tr[data-product-id]').forEach(row => {
            const productName = row.querySelector('.product-name').textContent;
            const dispatched = parseInt(row.dataset.dispatched);
            const returned = parseInt(row.querySelector('[data-type="returned"]').value) || 0;
            const damaged = parseInt(row.querySelector('[data-type="damaged"]').value) || 0;
            
            if (returned + damaged > dispatched) {
                errors.push(`${productName}: Returned (${returned}) + Damaged (${damaged}) exceeds Dispatched (${dispatched})`);
            }
        });
        
        // Validate cash
        if (!cashInput.value || parseFloat(cashInput.value) < 0) {
            errors.push('Please enter the cash returned amount');
        }
        
        if (errors.length > 0) {
            e.preventDefault();
            alert('‚ö†Ô∏è Please fix the following errors:\n\n' + errors.join('\n'));
        }
    });
})();
</script>

{% endblock %}
