{% extends 'accounts/base.html' %}

{% block title %}Sales Return Details - Chesanto Bakery{% endblock %}

{% block container_class %}container--wide{% endblock %}

{% block content %}
<style>
    .container--wide {
        max-width: 1200px;
    }
    
    /* Page Header */
    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
    }
    
    .page-header__left {
        flex: 1;
    }
    
    .page-header__title {
        font-size: 1.875rem;
        font-weight: 600;
        color: #111827;
        margin-bottom: 0.5rem;
    }
    
    .page-header__subtitle {
        font-size: 1rem;
        color: #6b7280;
    }
    
    .page-header__actions {
        display: flex;
        gap: 0.75rem;
    }
    
    /* Status Badge */
    .status-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        border-radius: 9999px;
        font-size: 0.875rem;
        font-weight: 500;
    }
    
    .status-badge--success {
        background: #d1fae5;
        color: #065f46;
    }
    
    .status-badge--warning {
        background: #fed7aa;
        color: #92400e;
    }
    
    .status-badge--error {
        background: #fee2e2;
        color: #991b1b;
    }
    
    /* Info Cards Grid */
    .info-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }
    
    .info-card {
        background: white;
        border: 2px solid #e5e7eb;
        border-radius: 0.75rem;
        padding: 2rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .info-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }
    
    .info-card__header {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid #e5e7eb;
    }
    
    .info-card__icon {
        font-size: 2rem;
        width: 3rem;
        height: 3rem;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #dbeafe;
        border-radius: 0.5rem;
    }
    
    .info-card__title {
        font-size: 1rem;
        font-weight: 600;
        color: #111827;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }
    
    .info-card__content {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }
    
    .info-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem 0;
    }
    
    .info-row__label {
        font-size: 0.875rem;
        color: #6b7280;
        font-weight: 500;
    }
    
    .info-row__value {
        font-size: 1.125rem;
        font-weight: 600;
        color: #111827;
    }
    
    .info-row__value--highlight {
        color: #2563eb;
        font-size: 1.25rem;
    }
    
    .info-row__value--success {
        color: #059669;
    }
    
    .info-row__value--error {
        color: #dc2626;
    }
    
    /* Products Table */
    .section {
        background: white;
        border: 2px solid #e5e7eb;
        border-radius: 0.75rem;
        padding: 2rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }
    
    .section__header {
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 3px solid #e5e7eb;
    }
    
    .section__title {
        font-size: 1.5rem;
        font-weight: 600;
        color: #111827;
    }
    
    .products-table {
        width: 100%;
        border-collapse: collapse;
    }
    
    .products-table thead {
        background: linear-gradient(135deg, #f9fafb 0%, #dbeafe 100%);
    }
    
    .products-table th {
        padding: 1rem;
        text-align: left;
        font-size: 0.75rem;
        font-weight: 600;
        color: #374151;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        border-bottom: 2px solid #d1d5db;
    }
    
    .products-table th:last-child,
    .products-table td:last-child {
        text-align: right;
    }
    
    .products-table tbody tr {
        border-bottom: 1px solid #e5e7eb;
        transition: background-color 0.15s;
    }
    
    .products-table tbody tr:hover {
        background: #f9fafb;
    }
    
    .products-table tbody tr:last-child {
        border-bottom: none;
    }
    
    .products-table td {
        padding: 1rem;
    }
    
    .product-name {
        font-weight: 600;
        font-size: 1rem;
        color: #111827;
    }
    
    .qty-badge {
        display: inline-block;
        padding: 0.5rem 0.75rem;
        border-radius: 0.375rem;
        font-size: 0.875rem;
        font-weight: 600;
        min-width: 50px;
        text-align: center;
    }
    
    .qty-badge--dispatched {
        background: #dbeafe;
        color: #1e40af;
        border: 1px solid #93c5fd;
    }
    
    .qty-badge--returned {
        background: #fed7aa;
        color: #92400e;
        border: 1px solid #fdba74;
    }
    
    .qty-badge--damaged {
        background: #fee2e2;
        color: #991b1b;
        border: 1px solid #fca5a5;
    }
    
    .qty-badge--sold {
        background: #d1fae5;
        color: #065f46;
        border: 1px solid #6ee7b7;
        font-size: 1rem;
    }
    
    /* Deficit Alert */
    .alert-box {
        padding: 1.5rem;
        border-radius: 0.75rem;
        margin-bottom: 1.5rem;
        border: 3px solid;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }
    
    .alert-box--warning {
        background: #fef3c7;
        border-color: #f59e0b;
    }
    
    .alert-box--error {
        background: #fee2e2;
        border-color: #dc2626;
    }
    
    .alert-box__title {
        font-size: 1.125rem;
        font-weight: 600;
        margin-bottom: 0.75rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .alert-box--warning .alert-box__title {
        color: #78350f;
    }
    
    .alert-box--error .alert-box__title {
        color: #991b1b;
    }
    
    .alert-box__text {
        font-size: 1rem;
        line-height: 1.6;
    }
    
    .alert-box--warning .alert-box__text {
        color: #92400e;
    }
    
    .alert-box--error .alert-box__text {
        color: #991b1b;
    }
</style>
</style>

<!-- Page Header -->
<div class="page-header">
    <div class="page-header__left">
        <h1 class="page-header__title">Sales Return #{{ sales_return.id }}</h1>
        <p class="page-header__subtitle">
            Return from {{ sales_return.dispatch.salesperson.name }} on {{ sales_return.return_date|date:"F d, Y" }}
            {% if sales_return.return_time %}at {{ sales_return.return_time|time:"g:i A" }}{% endif %}
        </p>
    </div>
    <div class="page-header__actions">
        <a href="{% url 'sales:sales_dashboard' %}" class="btn btn--secondary">‚Üê Back to Sales</a>
        <a href="{% url 'sales:dispatch_detail' sales_return.dispatch.id %}" class="btn btn--ghost">View Dispatch</a>
    </div>
</div>

<!-- Status Badge -->
{% if sales_return.sales_reconciled and sales_return.crates_returned %}
    <span class="status-badge status-badge--success">‚úÖ Return Complete</span>
{% elif sales_return.sales_reconciled %}
    <span class="status-badge status-badge--warning">üì¶ Sales Reconciled - Crates Pending</span>
{% else %}
    <span class="status-badge status-badge--error">‚è≥ Sales Reconciliation Pending</span>
{% endif %}

<!-- Info Cards -->
<div class="info-cards">
    <!-- Dispatch Info -->
    <div class="info-card">
        <div class="info-card__header">
            <span class="info-card__icon">üì¶</span>
            <h2 class="info-card__title">Dispatch Info</h2>
        </div>
        <div class="info-card__content">
            <div class="info-row">
                <span class="info-row__label">Dispatch Date</span>
                <span class="info-row__value">{{ sales_return.dispatch.date|date:"M d, Y" }}</span>
            </div>
            <div class="info-row">
                <span class="info-row__label">Salesperson</span>
                <span class="info-row__value">{{ sales_return.dispatch.salesperson.name }}</span>
            </div>
            <div class="info-row">
                <span class="info-row__label">Crates Dispatched</span>
                <span class="info-row__value">{{ sales_return.dispatch.crates_dispatched }}</span>
            </div>
            <div class="info-row">
                <span class="info-row__label">Expected Revenue</span>
                <span class="info-row__value info-row__value--highlight">KES {{ sales_return.dispatch.expected_revenue|floatformat:2 }}</span>
            </div>
        </div>
    </div>
    
    <!-- Return Info -->
    <div class="info-card">
        <div class="info-card__header">
            <span class="info-card__icon">‚Ü©Ô∏è</span>
            <h2 class="info-card__title">Return Info</h2>
        </div>
        <div class="info-card__content">
            <div class="info-row">
                <span class="info-row__label">Return Date</span>
                <span class="info-row__value">{{ sales_return.return_date|date:"M d, Y" }}</span>
            </div>
            <div class="info-row">
                <span class="info-row__label">Return Time</span>
                <span class="info-row__value">{% if sales_return.return_time %}{{ sales_return.return_time|time:"g:i A" }}{% else %}N/A{% endif %}</span>
            </div>
            <div class="info-row">
                <span class="info-row__label">Cash Collected</span>
                <span class="info-row__value info-row__value--highlight">KES {{ sales_return.cash_returned|floatformat:2 }}</span>
            </div>
            <div class="info-row">
                <span class="info-row__label">Status</span>
                <span class="info-row__value">
                    {% if sales_return.sales_reconciled and sales_return.crates_returned %}
                        <span class="status-badge status-badge--success">‚úÖ Complete</span>
                    {% elif sales_return.sales_reconciled %}
                        <span class="status-badge status-badge--warning">üì¶ Sales Done</span>
                    {% else %}
                        <span class="status-badge status-badge--error">‚è≥ Pending</span>
                    {% endif %}
                </span>
            </div>
        </div>
    </div>
    
    <!-- Commission Info (only if calculated) -->
    {% if sales_return.total_commission > 0 %}
    <div class="info-card">
        <div class="info-card__header">
            <span class="info-card__icon">üí∞</span>
            <h2 class="info-card__title">Commission</h2>
        </div>
        <div class="info-card__content">
            <div class="info-row">
                <span class="info-row__label">Per-Unit Commission</span>
                <span class="info-row__value">KES {{ sales_return.per_unit_commission|floatformat:2 }}</span>
            </div>
            <div class="info-row">
                <span class="info-row__label">Bonus Commission</span>
                <span class="info-row__value">KES {{ sales_return.bonus_commission|floatformat:2 }}</span>
            </div>
            <div class="info-row">
                <span class="info-row__label">Total Commission</span>
                <span class="info-row__value info-row__value--success" style="font-size: 1.25rem;">KES {{ sales_return.total_commission|floatformat:2 }}</span>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Products Breakdown -->
<div class="section">
    <div class="section__header">
        <h2 class="section__title">Products Breakdown</h2>
    </div>
    
    <table class="products-table">
        <thead>
            <tr>
                <th>Product</th>
                <th style="text-align: center;">Dispatched</th>
                <th style="text-align: center;">Returned</th>
                <th style="text-align: center;">Damaged</th>
                <th style="text-align: center;">Sold</th>
                <th>Unit Price</th>
                <th>Revenue</th>
                <th style="text-align: center;">Crates Returned</th>
                <th>Crate Condition</th>
            </tr>
        </thead>
        <tbody>
            {% for item in items %}
            <tr>
                <td class="product-name">{{ item.product.name }}</td>
                <td style="text-align: center;">
                    <span class="qty-badge qty-badge--dispatched">{{ item.units_dispatched }}</span>
                </td>
                <td style="text-align: center;">
                    {% if item.units_returned > 0 %}
                    <span class="qty-badge qty-badge--returned">{{ item.units_returned }}</span>
                    {% else %}
                    <span style="color: var(--gray-400);">‚Äî</span>
                    {% endif %}
                </td>
                <td style="text-align: center;">
                    {% if item.units_damaged > 0 %}
                    <span class="qty-badge qty-badge--damaged">{{ item.units_damaged }}</span>
                    {% else %}
                    <span style="color: var(--gray-400);">‚Äî</span>
                    {% endif %}
                </td>
                <td style="text-align: center;">
                    <span class="qty-badge qty-badge--sold">{{ item.units_sold }}</span>
                </td>
                <td>KES {{ item.selling_price|floatformat:2 }}</td>
                <td style="font-weight: 600; color: var(--green-600);">KES {{ item.gross_sales|floatformat:2 }}</td>
                <td style="text-align: center;">
                    {% if item.crates_returned > 0 %}
                    <span class="qty-badge qty-badge--returned">{{ item.crates_returned }}</span>
                    {% else %}
                    <span style="color: var(--gray-400);">‚Äî</span>
                    {% endif %}
                </td>
                <td>
                    {% if item.crate_condition == 'good' %}
                        <span style="color: var(--green-600); font-weight: 500;">‚úÖ Good</span>
                    {% elif item.crate_condition == 'damaged' %}
                        <span style="color: var(--orange-600); font-weight: 500;">‚ö†Ô∏è Damaged</span>
                    {% elif item.crate_condition == 'missing' %}
                        <span style="color: var(--red-600); font-weight: 500;">‚ùå Missing</span>
                    {% else %}
                        <span style="color: var(--gray-400);">‚Äî</span>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Deficit Reason (if any) -->
{% if sales_return.deficit_reason %}
<div class="section">
    <div class="section__header">
        <h2 class="section__title">üìù Deficit Explanation</h2>
    </div>
    <div style="background: var(--gray-50); padding: var(--spacing-6); border-radius: 0.5rem; border-left: 4px solid var(--blue-500);">
        <p style="color: var(--gray-800); line-height: 1.8; font-size: 1rem;">{{ sales_return.deficit_reason }}</p>
    </div>
</div>
{% endif %}

<!-- Summary Stats -->
<div class="info-cards">
    <div class="info-card">
        <div class="info-card__header">
            <span class="info-card__icon">üìä</span>
            <h2 class="info-card__title">Performance Summary</h2>
        </div>
        <div class="info-card__content">
            <div class="info-row">
                <span class="info-row__label">Cash Collected</span>
                <span class="info-row__value info-row__value--highlight">KES {{ sales_return.cash_returned|floatformat:2 }}</span>
            </div>
            <div class="info-row">
                <span class="info-row__label">Expected Revenue</span>
                <span class="info-row__value">KES {{ sales_return.dispatch.expected_revenue|floatformat:2 }}</span>
            </div>
            <div class="info-row">
                <span class="info-row__label">Collection Rate</span>
                <span class="info-row__value {% if sales_return.cash_returned >= sales_return.dispatch.expected_revenue %}info-row__value--success{% else %}info-row__value--error{% endif %}">
                    {% widthratio sales_return.cash_returned sales_return.dispatch.expected_revenue 100 %}%
                </span>
            </div>
            {% if sales_return.total_commission > 0 %}
            <div class="info-row">
                <span class="info-row__label">Commission Earned</span>
                <span class="info-row__value info-row__value--success">KES {{ sales_return.total_commission|floatformat:2 }}</span>
            </div>
            {% endif %}
        </div>
    </div>
</div>

{% endblock %}
